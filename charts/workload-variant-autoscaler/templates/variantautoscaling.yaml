{{- if .Values.wva.va.enabled }}
{{- if eq .Values.variantAutoscaling.deploymentMode "single" }}
{{- /* Single mode: Create one VA for the active accelerator (va.accelerator) */ -}}
{{- $activeVariant := dict }}
{{- range .Values.variantAutoscaling.variants }}
  {{- if eq .accelerator $.Values.va.accelerator }}
    {{- $activeVariant = . }}
  {{- end }}
{{- end }}
{{- if $activeVariant }}
---
apiVersion: llmd.ai/v1alpha1
kind: VariantAutoscaling
metadata:
  # In single mode: VA name includes accelerator for uniqueness
  name: {{ printf "%s-%s" $.Values.wva.modelName $.Values.va.accelerator | lower }}
  namespace: {{ $.Values.llmd.namespace }}
  labels:
    inference.optimization/acceleratorName: {{ $.Values.va.accelerator }}
spec:
  # Reference to the single deployment created by deployment scripts
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ printf "%s-decode" $.Values.wva.modelName }}
  modelID: {{ $.Values.variantAutoscaling.modelID | quote }}
  variantID: {{ printf "%s-%s-%d" $.Values.variantAutoscaling.modelID $.Values.va.accelerator (int ($activeVariant.acceleratorCount | default 1)) }}
  accelerator: {{ $.Values.va.accelerator }}
  acceleratorCount: {{ int ($activeVariant.acceleratorCount | default 1) }}
  sloClassRef:
    name: premium-slo
    key: opt-125m
  variantProfile:
    perfParms:
      decodeParms:
        alpha: {{ $activeVariant.perfParms.decodeParms.alpha | quote }}
        beta: {{ $activeVariant.perfParms.decodeParms.beta | quote }}
      prefillParms:
        gamma: {{ $activeVariant.perfParms.prefillParms.gamma | quote }}
        delta: {{ $activeVariant.perfParms.prefillParms.delta | quote }}
    maxBatchSize: {{ int ($activeVariant.maxBatchSize | default 512) }}
{{- end }}
{{- else if eq .Values.variantAutoscaling.deploymentMode "multi" }}
{{- /* Multi mode: Create one VA + Deployment for each variant */ -}}
{{- range .Values.variantAutoscaling.variants }}
---
apiVersion: llmd.ai/v1alpha1
kind: VariantAutoscaling
metadata:
  # In multi mode: VA name includes accelerator for uniqueness
  name: {{ printf "%s-%s" $.Values.wva.modelName .accelerator | lower }}
  namespace: {{ $.Values.llmd.namespace }}
  labels:
    inference.optimization/acceleratorName: {{ .accelerator }}
spec:
  # Reference to accelerator-specific deployment
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ printf "%s-%s-decode" $.Values.wva.modelName (.accelerator | lower) }}
  # OpenAI API compatible name of the model
  modelID: {{ $.Values.variantAutoscaling.modelID | quote }}
  # Unique identifier for this variant: modelID-accelerator-accCount
  variantID: {{ printf "%s-%s-%d" $.Values.variantAutoscaling.modelID .accelerator (int (.acceleratorCount | default 1)) }}
  accelerator: {{ .accelerator }}
  acceleratorCount: {{ int (.acceleratorCount | default 1) }}
  sloClassRef:
    name: premium-slo
    key: opt-125m
  variantProfile:
    perfParms:
      decodeParms:
        alpha: {{ .perfParms.decodeParms.alpha | quote }}
        beta: {{ .perfParms.decodeParms.beta | quote }}
      prefillParms:
        gamma: {{ .perfParms.prefillParms.gamma | quote }}
        delta: {{ .perfParms.prefillParms.delta | quote }}
    maxBatchSize: {{ int (.maxBatchSize | default 512) }}
{{- end }}
{{- end }}
{{- end }}
